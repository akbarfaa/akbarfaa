name: Update profile README

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "README.md"
      - ".github/workflows/update-readme.yml"

jobs:
  update:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const path = require("path");
            const readmePath = path.join(process.env.GITHUB_WORKSPACE, "README.md");
            let readme = fs.readFileSync(readmePath, "utf8");
            async function recentRepos() {
              const repos = await github.paginate(github.rest.repos.listForUser, { username: context.repo.owner, per_page: 100, type: "owner", sort: "updated", direction: "desc" });
              const filtered = repos.filter(r => !r.fork && !r.private).slice(0, 6);
              return filtered.map(r => {
                const desc = (r.description || "").replace(/\r?\n/g, " ").slice(0, 80);
                return `- <a href="https://github.com/${r.full_name}">${r.name}</a>${desc ? ` — ${desc}` : ""}`;
              }).join("\n");
            }
            async function recentPRs() {
              const res = await github.rest.search.issuesAndPullRequests({ q: `author:${context.repo.owner} type:pr is:public`, sort: "created", order: "desc", per_page: 5 });
              const items = res.data.items || [];
              return items.map(i => {
                const repo = i.repository_url ? i.repository_url.split("/repos/")[1] : "";
                const title = i.title.replace(/\r?\n/g, " ");
                return `- <a href="${i.html_url}">${title}</a>${repo ? ` — <a href="https://github.com/${repo}">${repo}</a>` : ""}`;
              }).join("\n");
            }
            function inject(section, start, end) {
              const re = new RegExp(`(<!-- ${start}:start -->)([\\s\\S]*?)(<!-- ${end}:end -->)`);
              return readme.replace(re, `$1\n${section || "- Tidak ada data"}\n$3`);
            }
            const reposBlock = await recentRepos();
            const prsBlock = await recentPRs();
            readme = inject(reposBlock, "recent_repos", "recent_repos");
            readme = inject(prsBlock, "recent_prs", "recent_prs");
            fs.writeFileSync(readmePath, readme);
      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-update README: repos & PR terbaru"
